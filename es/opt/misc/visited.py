#!/usr/bin/env python3
""""
many things that you might think to test, wont ever happen
of the things that do happen, a happen happen a lot and the others much less o
"""
import random,sys
import itertools,math
import numpy as np
from math import prod
from sparklines import sparklines

def pdf(alpha,bins):
  x=[1]
  for i in range(bins-1): x += [x[-1]*alpha]
  s = sum(x)
  x = sorted([y/s for y in x])
  return x

def probs(m):
  return [prod(item) for item in list(itertools.product(*m))]

def visited(d=2,alpha=.9, bins=16,keep=10**-4):
  m      = [pdf(alpha, bins) for _ in range(d)]
  a      = sorted(probs(m),reverse=True)
  kept   = [x for x in a if x > 0.00001]
  ignored = 100*(1- len(kept)/len(a))
  keys = (1+int(math.log(len(kept),2))) if len(kept)>0 else ""
  print(f"{bins:>4} | {d:>3} | {alpha:>2.1f} | {len(a):7} | {ignored:>7.2f} |  {len(kept):5}", end="")
  for t in [0.0001, 0.001, 0.01, 0.1]:
      kept  = [x for x in a if x > t]
      print(f" | {len(kept):5}",end="")
  print(f" | {keys:>4}")

random.seed(1)
bins = 8
print("bins |   d |   a |     all | missed% |  10^-5 | 10^-4 | 10^-3 | 10^-2 | 10^-1 | keys")
print("---- | --- | --- | ------- | ------- | ------ | ----- | ----- | ----- | ----- | ----")
for d in [2,3,4,5,6]:
  for _ in range(10):
    alpha = 0.1 + random.uniform(0,0.8) +0.1
    visited(d=d,bins=bins,alpha=alpha)

"""
bins |   d |   a |     all | missed% |  10^-5 | 10^-4 | 10^-3 | 10^-2 | 10^-1 | keys
---- | --- | --- | ------- | ------- | ------ | ----- | ----- | ----- | ----- | ----
   8 |   2 | 0.3 |      64 |   23.44 |     49 |    36 |    21 |    10 |     3 |    6
   8 |   2 | 0.9 |      64 |    0.00 |     64 |    64 |    64 |    49 |     0 |    7
   8 |   2 | 0.8 |      64 |    0.00 |     64 |    64 |    64 |    43 |     0 |    7
   8 |   2 | 0.4 |      64 |    9.38 |     58 |    49 |    28 |    10 |     3 |    6
   8 |   2 | 0.6 |      64 |    0.00 |     64 |    64 |    49 |    21 |     3 |    7
   8 |   2 | 0.6 |      64 |    0.00 |     64 |    63 |    49 |    21 |     3 |    7
   8 |   2 | 0.7 |      64 |    0.00 |     64 |    64 |    63 |    28 |     0 |    7
   8 |   2 | 0.8 |      64 |    0.00 |     64 |    64 |    64 |    43 |     0 |    7
   8 |   2 | 0.3 |      64 |   32.81 |     43 |    28 |    15 |    10 |     3 |    6
   8 |   2 | 0.2 |      64 |   43.75 |     36 |    21 |    15 |     6 |     3 |    6
   8 |   3 | 0.9 |     512 |    0.00 |    512 |   512 |   428 |     0 |     0 |   10
   8 |   3 | 0.5 |     512 |   10.94 |    456 |   304 |   120 |    20 |     0 |    9
   8 |   3 | 0.8 |     512 |    0.00 |    512 |   512 |   350 |     4 |     0 |   10
   8 |   3 | 0.2 |     512 |   83.59 |     84 |    56 |    20 |    10 |     4 |    7
   8 |   3 | 0.6 |     512 |   10.94 |    456 |   304 |   120 |    20 |     0 |    9
   8 |   3 | 0.8 |     512 |    0.00 |    512 |   511 |   304 |    10 |     0 |   10
   8 |   3 | 0.4 |     512 |   50.00 |    256 |   162 |    56 |    20 |     1 |    9
   8 |   3 | 1.0 |     512 |    0.00 |    512 |   512 |   512 |     0 |     0 |   10
   8 |   3 | 0.9 |     512 |    0.00 |    512 |   512 |   502 |     0 |     0 |   10
   8 |   3 | 0.2 |     512 |   76.56 |    120 |    56 |    35 |    10 |     4 |    7
   8 |   4 | 0.2 |    4096 |   94.87 |    210 |   126 |    35 |    15 |     1 |    8
   8 |   4 | 0.6 |    4096 |   29.91 |   2871 |  1225 |   210 |     5 |     0 |   12
   8 |   4 | 1.0 |    4096 |    0.00 |   4096 |  4096 |     0 |     0 |     0 |   13
   8 |   4 | 0.5 |    4096 |   62.40 |   1540 |   695 |   210 |    15 |     0 |   11
   8 |   4 | 0.4 |    4096 |   83.03 |    695 |   330 |   126 |    15 |     1 |   10
   8 |   4 | 0.5 |    4096 |   54.20 |   1876 |   695 |   210 |    15 |     0 |   11
   8 |   4 | 0.2 |    4096 |   91.94 |    330 |   126 |    35 |    15 |     1 |    9
   8 |   4 | 0.4 |    4096 |   83.03 |    695 |   330 |   126 |    15 |     1 |   10
   8 |   4 | 0.6 |    4096 |   54.20 |   1876 |   941 |   210 |    15 |     0 |   11
   8 |   4 | 0.6 |    4096 |   37.60 |   2556 |   941 |   210 |    15 |     0 |   12
   8 |   5 | 0.4 |   32768 |   93.98 |   1972 |   792 |   126 |    21 |     0 |   11
   8 |   5 | 0.4 |   32768 |   93.98 |   1972 |   792 |   126 |    21 |     0 |   11
   8 |   5 | 0.4 |   32768 |   93.98 |   1972 |   462 |   126 |    21 |     0 |   11
   8 |   5 | 0.6 |   32768 |   77.70 |   7308 |  1282 |   126 |     1 |     0 |   13
   8 |   5 | 0.4 |   32768 |   91.16 |   2898 |   792 |   126 |    21 |     0 |   12
   8 |   5 | 0.2 |   32768 |   98.59 |    462 |   252 |    56 |    21 |     1 |    9
   8 |   5 | 0.9 |   32768 |   12.48 |  28680 |   792 |     0 |     0 |     0 |   15
   8 |   5 | 0.6 |   32768 |   71.56 |   9318 |  1972 |   126 |     0 |     0 |   14
   8 |   5 | 0.7 |   32768 |   57.51 |  13924 |  1972 |    21 |     0 |     0 |   14
   8 |   5 | 0.3 |   32768 |   96.09 |   1282 |   462 |   126 |    21 |     1 |   11
   8 |   6 | 1.0 |  262144 |  100.00 |      0 |     0 |     0 |     0 |     0 |
   8 |   6 | 0.9 |  262144 |   95.47 |  11872 |     0 |     0 |     0 |     0 |   14
   8 |   6 | 0.3 |  262144 |   99.35 |   1716 |   462 |    84 |    28 |     1 |   11
   8 |   6 | 0.5 |  262144 |   97.01 |   7840 |  1716 |   210 |     7 |     0 |   13
   8 |   6 | 0.8 |  262144 |   90.71 |  24360 |   210 |     0 |     0 |     0 |   15
   8 |   6 | 0.8 |  262144 |   90.71 |  24360 |   210 |     0 |     0 |     0 |   15
   8 |   6 | 0.9 |  262144 |  100.00 |      7 |     0 |     0 |     0 |     0 |    3
   8 |   6 | 0.5 |  262144 |   95.47 |  11872 |  1716 |    84 |     1 |     0 |   14
   8 |   6 | 0.9 |  262144 |   93.40 |  17304 |     0 |     0 |     0 |     0 |   15
   8 |   6 | 0.7 |  262144 |   90.71 |  24360 |   462 |     0 |     0 |     0 |   15
"""
